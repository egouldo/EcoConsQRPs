---
title: "QRPs in Ecological Modelling"
format:
  html:
    page-layout: full
editor: visual
bibliography: references.bib
editor_options: 
  chunk_output_type: inline
---

# Prepare Data

```{r}
#| label: setup
#| warning: false
#| message: false
library(tidyverse)
library(here)
library(janitor)
library(gt)
library(gtExtras)
library(ggh4x)
library(ggforce)
library(waffle)

source(here::here("R/tidy_QRP_database.R"))
source(here::here("R/make_table_data.R"))
source(here::here("R/make_QRP_table.R"))

```

```{r}
#| label: tbl-QRP
#| result: asis
#| column: body-outset
#| warning: false
#| message: false

gt_qrp <- tidy_QRP_database(here::here("data", "QRP_database.csv")) %>% 
  make_qrp_table_data() %>% 
    select(-notes) %>% 
  make_QRP_table() %>% 
  gt::fmt_markdown(columns = c(qrp_coded, practice_coded, source)) %>% 
  gtExtras::gt_color_box(
    columns = c(-ends_with("_coded"), -source, -target),
    palette = c("lightgrey", "purple"), labels = FALSE,
    domain = c(0, 1)
  ) %>% 
  gt::cols_hide(columns = c(-ends_with("coded"), -source, -target) ) 

gt_qrp

#gt_qrp %>% gt::gtsave(path = here::here("tables"), filename = "qrp_table_draft.pdf")
```

```{r}
#| label: make-qrp-table-data
#| warning: false
#| message: false

tbl_data <- 
        tidy_QRP_database(here::here("data", "QRP_database.csv")) %>% 
        make_qrp_table_data() 
```

# Testing visualisations on data subsets

```{r}
#| warning: false
#| message: false
#| echo: false
#| label: sandbox

tbl_data_subset <- 
  tbl_data %>%  
  rename(practice_source = source) %>% 
  select(target, practice_coded, practice_source) %>% 
  mutate(target = stringr::str_split(target, ", ")) %>% 
  unnest(target) %>% 
  ungroup() %>% 
  mutate(amount = 1) %>% 
  complete(practice_coded, target, fill = list(amount = 0)) %>% 
  group_by(practice_coded) %>%
  ungroup() %>% 
  fill(practice_source, .direction = "up") %>% 
  slice(1:15) 

tbl_data_subset %>%        
  ggplot() +
  geom_arc_bar(
    aes(x0 = 0, y0 = 0, r0 = 0.5, r = 1, 
        fill = target, amount = amount),
    stat = "pie",
    linewidth = 0) +
  facet_grid(practice_coded ~ ., switch = "y", 
             labeller = labeller(practice_coded = 
                                   label_wrap_gen(width = 20))) +
  coord_fixed() +
  scale_fill_brewer(palette = "Set3") +
  theme_no_axes() +
  theme(strip.text.y.left = element_text(angle = 0,size = 5))
```

```{r}
#| label: waffle_plot_subset
#| error: true
tbl_data_subset %>% 
        ggplot(aes(fill = target, values = amount)) +
        geom_waffle(size = 1, 
                    color = "white", 
                    make_proportional = FALSE, 
                    flip = TRUE) +
        coord_equal() +
        facet_grid(practice_coded ~ ., switch = "y", 
             labeller = labeller(practice_coded = 
                                   label_wrap_gen(width = 20))) +
        theme_no_axes() +
        theme(strip.text.y.left = element_text(angle = 0,size = 5))
```

# Full Dataset Plot

## Donut Plots

(Output suppressed)

```{r}
#| label: make-donut-table-data
tbl_data_donuts <- tbl_data %>%  
        rename(practice_source = source) %>% 
        select(-reason_coded, -notes) %>% 
        mutate(target = stringr::str_split(target, ", ")) %>% 
        unnest(target) %>% 
        ungroup() %>% 
        mutate(amount = 1) %>% 
        complete(practice_coded, target) %>% 
        group_by(practice_coded) %>%
        fill(practice_source, qrp_coded, .direction = "up") %>% 
        mutate(across(where(is.double), ~ replace_na(., 0))) %>% 
        select(-amount) %>% 
        pivot_longer(cols = -c(practice_coded, 
                               target, qrp_coded, 
                               practice_source),
                     names_to = "modelling_phase", 
                     values_to = "amount") %>% 
        separate(modelling_phase, 
                 into = c("modelling_phase", "modelling_subphase"), 
                 sep = " - ", remove = TRUE) 
```

```{r}
#| warning: false
#| message: false
#| include: false
#| eval: false
#| label: donut_plot
#| results: hide
# let's try create donuts for each modelling phase
# strip_theming <- ggh4x::strip_themed(
#         text_x = ggh4x::elem_list_text(angle = c(0,90)),
#         by_layer_x = TRUE
# )

tbl_data_donuts %>%
        ggplot() +
        geom_arc_bar(aes(x0 = 0, y0 = 0, r0 = 0.5, r = 1, 
                         fill = target, 
                         amount = amount),
                     stat = "pie",
                     linewidth = 0) +
        facet_grid2(practice_coded ~ modelling_phase + modelling_subphase, switch = "y", 
                    labeller = labeller(practice_coded = label_wrap_gen(width = 70)),
                    strip = 
                            strip_nested(bleed = TRUE,  
                                         text_x = ggh4x::elem_list_text(angle = c(0,90)),
                                         by_layer_x = TRUE, 
                                         size = "variable")) +
        # facet_nested(practice_coded ~ modelling_phase + modelling_subphase, switch = "y", 
        #            labeller = labeller(practice_coded = label_wrap_gen(width = 70)),
        #            render_empty = FALSE,
        #            strip = strip_theming) +
        coord_fixed() +
        scale_fill_brewer(palette = "Set3") +
        theme_no_axes() +
        theme(strip.text.y.left = element_text(angle = 0, size = 8),
              panel.spacing = unit(0,'lines'),
              strip.background = element_rect(fill = "lightgrey", 
                                              colour = "white", 
                                              linewidth = 0.5),
              ggh4x.facet.nestline = 
                      element_line(colour = "black", 
                                   linetype = 1, 
                                   linewidth = 1))
```

## Waffle Plot

```{r}
#| results: hide
#| label: waffle_plot_sandbox_all
#| error: true
tbl_data_donuts %>%
    select(modelling_subphase, -practice_source, -qrp_coded) %>% 
    distinct() %>% 
    group_split() %>% 
    pluck(1) %>% 
        ggplot(aes(y = modelling_phase, fill = target, values = amount)) +
        geom_waffle(make_proportional = FALSE, flip = FALSE, size = 1, 
                    color = "white",na.rm = FALSE) +
        coord_equal() 

tbl_data_donuts %>%
    select(-modelling_subphase, -practice_source, -qrp_coded) %>% 
    distinct() %>% 
    group_split() %>% 
    pluck(1) %>% 
        ggplot(aes(x = modelling_phase, fill = target, values = amount)) +
        geom_waffle(make_proportional = FALSE, flip = F, size = 1, 
                    color = "white") +
        coord_equal() 

tbl_data_donuts %>%
        select(-modelling_subphase, -practice_source, -qrp_coded) %>% 
        distinct() %>% 
        ggplot(aes(fill = target, values = amount)) +
        geom_waffle(size = 1, 
                    color = "white", 
                    make_proportional = FALSE, 
                    flip = TRUE) +
        coord_fixed() +
        facet_grid(practice_coded ~ modelling_phase)
        theme_no_axes() 
        
```

```{r}
#| label: waffle_data_prep
#| echo: true
#| message: false
#| warning: false
waffle_plot_data <- 
        tidy_QRP_database(here::here("data", "QRP_database.csv")) %>% 
        filter(include) %>% 
        select(-notes, -model_subphase, -source, -reason_coded, -include) %>% 
        distinct() %>% #rm duplicate practice_coded #TODO next merge duplicates while keeping source
        drop_na() %>% #interim approach until datachecks in place
        mutate(model_phase = str_split(model_phase, ", "),
               target = str_split(target, ", "),
               values = 1) %>% 
        unnest(model_phase) %>% 
        unnest(target) %>% 
        complete(practice_coded, 
                 model_phase, 
                 target, 
                 fill = list(values = 0.0001) # see https://github.com/hrbrmstr/waffle/issues/66
                 ) %>%  
        group_by(practice_coded) %>% 
        fill(qrp_coded, model_phase, .direction = "downup") %>% 
        ungroup()
```

```{r}
#| label: fig-waffle_plot
#| fig-cap: "Where QRPs occur in the modelling cycle and their targets."
#| fig-width: 15
#| fig-height: 15

waffle_plot_data %>% 
        distinct() %>% #TODO identify duplicated rows - suspect non-unique target coding is cause
        mutate(model_phase = 
                       forcats::as_factor(model_phase) %>% 
                       forcats::fct_relevel( c("Data", 
                                               "Model Construction", 
                                               "Model Evaluation",
                                               "Model Application"))) %>% 
        arrange(model_phase, qrp_coded) %>% 
        ggplot(aes(fill = target, values = values)) +
        geom_waffle(size = 0.05, 
                    color = "white", 
                    make_proportional = FALSE, 
                    flip = TRUE) +
        scale_x_discrete(expand = c(0,0)) +
        scale_y_discrete(expand = c(0,0)) +
        coord_equal() +
        facet_nested(qrp_coded + practice_coded ~ model_phase, 
                     switch = "y", 
                     labeller = labeller(practice_coded =
                                                 label_wrap_gen(width = 100, 
                                                                multi_line = TRUE),
                                         qrp_coded = 
                                                 label_wrap_gen(width = 10, 
                                                                multi_line = TRUE)),
                     nest_line = element_line(linetype = 1),
                     solo_line = TRUE,
                     space = "free",
                     strip = strip_nested(size = "variable",
                                          clip = "off")
                     ) +
        # facet_grid(practice_coded ~ model_phase, 
        #            switch = "y", 
        #            labeller = labeller(practice_coded = 
        #                                        label_wrap_gen(width = 100))) +
        # theme_no_axes() +
        theme(strip.text.y.left = element_text(angle = 0, size = 10, ),
              #strip.text.x = element_text(angle = 45), 
              strip.background.y = element_blank()
              #plot.background = element_rect(fill = "white", colour = "white"),
              #panel.background = element_rect(colour = "white", fill = "white")
              ) +
        waffle::theme_enhance_waffle() +
        ggh4x::force_panelsizes(rows = unit(1, "cm"), cols = unit(3, "cm"))

#DONE reorder the model process levels
#TODO exclude less important QRPs
#TODO recolour model object colours
#DONE group the QRPs into their umbrella terms -- nested facets?


```

```{r}
#| label: tbl-QRP-categories
waffle_plot_data %>% 
        distinct(qrp_coded) %>% 
        arrange(qrp_coded) %>% 
        knitr::kable(caption = "QRP categories")
```

# Notes

*Diagram*

-   QRPs on y-axis, model phase / subphase on x-axis (top facets), nested.
-   There's mark (donut) if the QRP occurs in that phase / subphase.
-   The donut is coloured according to the target of the QRP, from Figure 1: input/model/output.
-   Have simplified the phases / subphases into broader categories

*Questions*

-   [ ] What QRP grouping categories can we drop? ONLY USE ONE CATEGORY for each

-   [ ] What symbols to use?

    \- Dumping ground catgegory 'Poor Practice': for QRPs that don't fit into the other categories

    \- Examples of poor practice include: - Not validating the model on independent data: the location of the QRP is actually somewhere else... maybe with other users.

    \- engaging in commonly used techniques / practices, but that are known to be problematic, e.g. using AUC as a performance metric

    -   'incomplete' "application" or something similar. Where the full method is not applied.
    -   Misuse/Misapplication of an existing metric.

**Todo:**

-   [x] Can merge some phases / subphases
-   [x] Aggregate some QRPs, they are essentially the same

For the main figure:

-   [x] only have single groups (of QRP categories / codes `qrp_coded` ) & simplify the text (i.e. the description of each QRP `practice_coded` ).
-   [ ] For each broad category can have two example QRPs - either most important (worst outcome), and easiest to explain. Only include hard to explain QRP in if it's serious and common.

fuzzy area - poor practice vs. QRP. Potentially consider dropping some QRPs from the list.

'Not following best-modelling practice'.

QRPs invisible? Harder to spot. Incomplete reporting + ~*dishonest*~*/ambiguous/misleading* framing.

Other problems like (e.g. QRPs that are poor practice)

Incomplete reporting (QRP problem) stops you from fairly evaluating the research that was done. So if people reported their modeling proces fully then we would be able to discriminate when people are *not* doing best practice, and when they are.

-   [ ] just have table + text in supp mat.

Here's the problem. 20 years of people illustrating best-practice.

We're not going to address that.

We can't fairly evaluate the literature because of this poor transparency. Don't have to force modellers to change, but can encourage reviewers editors to push modellers' to report their modelling process more fully. reference point for reviewers to give to editor. Ammunition for reviewers to push back. Giving them language to start calling these things out. FAIRLY EVALUATING SOMEONE's WORK. We're so hard we are on people who deviate from prereg plans.

# 6 august

Have weaned out a third of them that fit squarely in "poor modelling practice" (out of 42)

But still not sure about some other ones.
